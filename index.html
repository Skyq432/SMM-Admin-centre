<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Command Center | Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #f8fafc;
        }
        .glass-card {
            background: rgba(255, 255, 255, 1);
            border: 1px solid #e2e8f0;
        }
        .mobile-mockup {
            width: 280px;
            height: 480px;
            border: 10px solid #0f172a;
            border-radius: 36px;
            position: relative;
            overflow: hidden;
            background: white;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 10px;
        }
        .btn-emerald {
            background-color: #059669;
            transition: all 0.2s ease;
        }
        .btn-emerald:hover {
            background-color: #047857;
        }
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }
        .file-input-wrapper input[type=file] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
        }
        .day-active {
            background-color: #059669;
            color: white;
        }
        .day-selected {
            ring: 2px solid #10b981;
            ring-offset: 2px;
        }
        #brandLogoPreview {
            width: 32px;
            height: 32px;
            object-fit: contain;
            border-radius: 6px;
            background: #f1f5f9;
        }
    </style>
</head>
<body class="text-slate-800 antialiased">

    <!-- TOP BAR -->
    <header class="sticky top-0 z-50 w-full border-b border-slate-200 bg-white/90 backdrop-blur-md px-6 py-3">
        <div class="max-w-7xl mx-auto flex flex-wrap items-center justify-between gap-4">
            <div class="flex items-center gap-8">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-slate-900 rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    </div>
                    <h1 class="text-lg font-bold text-slate-900 tracking-tight">COMMAND CENTER</h1>
                </div>
                
                <div class="flex items-center gap-6">
                    <!-- Brand Selector with Logo Display -->
                    <div class="flex items-center gap-3">
                        <div class="relative group cursor-pointer" onclick="document.getElementById('logoUploadInput').click()">
                            <img id="brandLogoDisplay" src="https://ui-avatars.com/api/?name=B&background=f1f5f9&color=cbd5e1" alt="Logo" class="w-9 h-9 rounded-lg border border-slate-200 object-contain bg-white">
                            <div class="absolute inset-0 bg-black/40 rounded-lg opacity-0 group-hover:opacity-100 flex items-center justify-center transition-opacity">
                                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                            </div>
                            <input type="file" id="logoUploadInput" class="hidden" accept="image/*" onchange="uploadBrandLogo(this)">
                        </div>
                        <div class="flex flex-col">
                            <label class="text-[9px] font-bold uppercase text-slate-400 tracking-widest">Brand Profile</label>
                            <select id="brandSelect" class="bg-transparent font-bold focus:outline-none text-slate-800 text-sm cursor-pointer" onchange="loadBrandMetadata(); loadWeeklyData();">
                                <option value="19d27e5f-b230-4c2a-a5a7-6c2e59fbba88">Natures Treasure</option>
                                <option value="idonstore-id-placeholder">Idonstore</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="h-6 w-px bg-slate-200"></div>
                    
                    <div class="flex flex-col">
                        <label class="text-[9px] font-bold uppercase text-slate-400 tracking-widest">Post Schedule</label>
                        <input type="date" id="postDate" class="bg-transparent font-bold focus:outline-none text-slate-800 text-sm cursor-pointer" onchange="syncWeekWithDate()">
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-3">
                <button onclick="generateApprovalLink()" class="text-[10px] font-bold text-slate-500 border border-slate-200 px-3 py-1.5 rounded-lg hover:bg-slate-50 uppercase tracking-widest flex items-center gap-2">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg>
                    Copy Client Link
                </button>
                <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 font-bold border border-slate-200">AD</div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-6 grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <!-- ZONE B: CREATION & PLANNING -->
        <div class="lg:col-span-7 space-y-6">
            
            <!-- WEEKLY PLANNING DASHBOARD -->
            <div class="glass-card rounded-2xl p-6 shadow-sm mb-6 border-l-4 border-l-emerald-500">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-4">
                        <button onclick="changeWeek(-1)" class="p-2 hover:bg-slate-50 rounded-full text-slate-400">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                        </button>
                        <h3 id="weekRangeDisplay" class="text-sm font-bold text-slate-900 uppercase tracking-widest">
                            Loading week...
                        </h3>
                        <button onclick="changeWeek(1)" class="p-2 hover:bg-slate-50 rounded-full text-slate-400">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </button>
                    </div>
                    <div id="weeklyStatusBadge" class="bg-amber-50 text-amber-700 text-[10px] font-bold px-3 py-1 rounded-full uppercase tracking-widest">
                        Work in Progress
                    </div>
                </div>

                <div id="weekDaysGrid" class="grid grid-cols-7 gap-2 mb-6">
                    <!-- Days loaded via JS -->
                </div>

                <div class="flex items-center justify-between pt-4 border-t border-slate-100">
                    <div class="flex flex-col">
                        <p class="text-[10px] text-slate-400 font-medium italic">Click a date to view or schedule content.</p>
                        <button onclick="resetFormToNew()" class="text-[9px] font-bold text-indigo-500 uppercase mt-1 hover:underline">Clear / Create New</button>
                    </div>
                    <button id="approveWeekBtn" onclick="toggleWeeklyApproval()" class="bg-slate-900 text-white text-[10px] font-bold px-4 py-2 rounded-lg hover:bg-slate-800 transition-all uppercase tracking-widest">
                        Submit Week for Review
                    </button>
                </div>
            </div>

            <div class="glass-card rounded-2xl p-8 shadow-sm">
                <div class="flex items-center justify-between mb-8">
                    <div>
                        <h2 class="text-xl font-bold text-slate-900" id="formTitle">Content Composer</h2>
                        <p class="text-slate-500 text-xs">Structural data for multi-brand posts</p>
                    </div>
                    <div id="versionLabel" class="bg-slate-100 text-slate-600 text-[10px] font-bold px-3 py-1 rounded-full uppercase tracking-wider">
                        New Post
                    </div>
                </div>

                <!-- Post Type -->
                <div class="mb-6">
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-3">Content Type</label>
                    <div class="flex gap-2">
                        <button onclick="setPostType('single')" id="btn-single" class="type-btn flex-1 py-2 text-xs font-bold rounded-lg bg-slate-900 text-white shadow-md transition-all">Single</button>
                        <button onclick="setPostType('carousel')" id="btn-carousel" class="type-btn flex-1 py-2 text-xs font-bold rounded-lg border border-slate-200 text-slate-500 hover:bg-slate-50 transition-all">Carousel</button>
                        <button onclick="setPostType('video')" id="btn-video" class="type-btn flex-1 py-2 text-xs font-bold rounded-lg border border-slate-200 text-slate-500 hover:bg-slate-50 transition-all">Video</button>
                    </div>
                </div>

                <!-- Caption -->
                <div class="mb-6">
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">Caption</label>
                    <textarea id="captionInput" rows="4" class="w-full p-4 rounded-xl border border-slate-200 focus:ring-1 focus:ring-emerald-500 focus:border-emerald-500 transition-all outline-none text-sm leading-relaxed" placeholder="Write your post caption..."></textarea>
                </div>

                <!-- Media Files -->
                <div class="mb-10">
                    <div class="flex items-center justify-between mb-4">
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest">Media Assets (Upload)</label>
                        <button onclick="addSlide()" id="addSlideBtn" class="text-[10px] font-bold text-emerald-600 hover:text-emerald-700 uppercase tracking-widest flex items-center gap-1">
                            + Add Slide
                        </button>
                    </div>
                    <div id="mediaContainer" class="space-y-3">
                        <div class="flex items-center gap-3 p-3 border border-dashed border-slate-300 rounded-xl bg-slate-50/50">
                            <div class="file-input-wrapper">
                                <button class="w-full text-left text-xs text-slate-500 font-medium py-1 px-2 text-ellipsis overflow-hidden">Click to select file...</button>
                                <input type="file" class="media-file-input" accept="image/*,video/*" onchange="handleFileSelect(this)">
                            </div>
                            <span class="file-name text-[10px] text-slate-400 italic truncate max-w-[150px]">No file chosen</span>
                        </div>
                    </div>
                    <div id="existingMediaDisplay" class="mt-4 flex flex-wrap gap-2"></div>
                </div>

                <div id="msg" class="mb-4 text-xs font-medium min-h-[1.5rem] p-3 rounded-lg hidden"></div>

                <button id="submitBtn" onclick="submitPost()" class="w-full btn-emerald text-white font-bold py-4 rounded-xl shadow-lg shadow-emerald-100 hover:shadow-xl transition-all flex items-center justify-center gap-2">
                    Submit Version
                </button>
            </div>
        </div>

        <!-- ZONE C: PREVIEW & HISTORY -->
        <div class="lg:col-span-5 space-y-8">
            <!-- LIVE PREVIEW -->
            <div class="glass-card rounded-2xl p-8 flex flex-col items-center shadow-sm">
                <h3 class="text-[10px] font-bold text-slate-400 mb-6 uppercase tracking-widest">Visual Preview</h3>
                <div class="mobile-mockup">
                    <div class="px-4 py-3 flex items-center gap-2 border-b border-slate-50 bg-white">
                        <div id="previewLogo" class="w-5 h-5 rounded bg-slate-100 overflow-hidden">
                            <img id="previewLogoImg" src="" class="w-full h-full object-contain hidden">
                        </div>
                        <span id="previewBrand" class="text-[10px] font-bold text-slate-800">Brand Name</span>
                    </div>
                    <div id="previewMedia" class="w-full h-[280px] bg-slate-50 flex items-center justify-center relative overflow-hidden">
                        <span class="text-[10px] text-slate-300 font-medium">No Asset Provided</span>
                    </div>
                    <div class="p-4">
                        <div class="flex items-center gap-3 mb-3 text-slate-700">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                        </div>
                        <p id="previewCaption" class="text-[11px] text-slate-600 leading-normal line-clamp-4">
                            Captions help tell your story...
                        </p>
                    </div>
                </div>
            </div>

            <!-- VERSION HISTORY -->
            <div class="glass-card rounded-2xl p-6 shadow-sm flex flex-col max-h-[400px]">
                <h3 class="text-xs font-bold text-slate-900 mb-4 flex items-center gap-2 uppercase tracking-widest">
                    Timeline & History
                </h3>
                <div id="historyContainer" class="space-y-4 overflow-y-auto custom-scrollbar flex-1 pr-2 text-center py-8">
                    <p class="text-[10px] text-slate-400 italic">Select a date to see historical versions.</p>
                </div>
            </div>
        </div>
    </main>

    <script>
        // CONFIGURATION
        const supabaseUrl = 'https://ohflkfevuapwqtkpsqlo.supabase.co';
        const supabaseKey = 'sb_publishable_U2yJZn0K-XQF_0bGPfGvJQ_hA5-ja0F';
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        const STORAGE_BUCKET = 'media';

        // State Management
        let postType = 'single';
        let viewDate = new Date();
        let isWeekApproved = false;
        let currentSlot = null;
        let currentVersions = [];
        
        // UI References
        const captionInput = document.getElementById('captionInput');
        const mediaContainer = document.getElementById('mediaContainer');
        const existingMediaDisplay = document.getElementById('existingMediaDisplay');
        const previewMedia = document.getElementById('previewMedia');
        const previewCaption = document.getElementById('previewCaption');
        const msgBox = document.getElementById('msg');
        const submitBtn = document.getElementById('submitBtn');
        const postDateInput = document.getElementById('postDate');
        const weekRangeDisplay = document.getElementById('weekRangeDisplay');
        const weekDaysGrid = document.getElementById('weekDaysGrid');
        const weeklyStatusBadge = document.getElementById('weeklyStatusBadge');
        const approveWeekBtn = document.getElementById('approveWeekBtn');
        const brandSelect = document.getElementById('brandSelect');
        const versionLabel = document.getElementById('versionLabel');
        const formTitle = document.getElementById('formTitle');
        const historyContainer = document.getElementById('historyContainer');
        
        const brandLogoDisplay = document.getElementById('brandLogoDisplay');
        const previewLogoImg = document.getElementById('previewLogoImg');

        postDateInput.valueAsDate = new Date();

        const MEDIA_PLACEHOLDER = `<span class="text-[10px] text-slate-300 font-medium italic">Visual Preview</span>`;

        // 1. Weekly Logic
        function getWeekInfo(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            const monday = new Date(d.setDate(diff));
            const sunday = new Date(new Date(monday).setDate(monday.getDate() + 6));
            return { monday, sunday };
        }

        window.changeWeek = (offset) => {
            viewDate.setDate(viewDate.getDate() + (offset * 7));
            loadWeeklyData();
        };

        window.syncWeekWithDate = () => {
            viewDate = new Date(postDateInput.value);
            loadWeeklyData();
            fetchPostForDate(postDateInput.value);
        };

        window.selectDate = (iso) => {
            postDateInput.value = iso;
            loadWeeklyData();
            fetchPostForDate(iso);
        };

        window.generateApprovalLink = () => {
            const { monday } = getWeekInfo(viewDate);
            const dateStr = monday.toISOString().split('T')[0];
            const brandId = brandSelect.value;
            // Assuming the client portal URL structure
            const link = `${window.location.origin}/client-portal?brand=${brandId}&week=${dateStr}`;
            
            // Clipboard logic
            const el = document.createElement('textarea');
            el.value = link;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            
            showToast("Client Link copied to clipboard!", "success");
        };

        // Brand Logo Management
        async function loadBrandMetadata() {
            const brandId = brandSelect.value;
            const brandName = brandSelect.options[brandSelect.selectedIndex].text;
            
            // Set basic UI recognition
            previewBrand.innerText = brandName;
            
            try {
                // Fetch brand details from a 'brands' table
                const { data, error } = await _supabase
                    .from('brands')
                    .select('logo_url')
                    .eq('id', brandId)
                    .maybeSingle();

                if (data && data.logo_url) {
                    brandLogoDisplay.src = data.logo_url;
                    previewLogoImg.src = data.logo_url;
                    previewLogoImg.classList.remove('hidden');
                } else {
                    const fallback = `https://ui-avatars.com/api/?name=${brandName.charAt(0)}&background=f1f5f9&color=cbd5e1`;
                    brandLogoDisplay.src = fallback;
                    previewLogoImg.classList.add('hidden');
                }
            } catch (err) {
                console.error("Error loading brand metadata:", err);
            }
        }

        window.uploadBrandLogo = async (input) => {
            if (!input.files || !input.files[0]) return;
            
            const file = input.files[0];
            const brandId = brandSelect.value;
            const brandName = brandSelect.options[brandSelect.selectedIndex].text;
            
            // Helper to generate a slug from the brand name
            const generateSlug = (name) => {
                return name.toLowerCase()
                    .replace(/\s+/g, '-')
                    .replace(/[^\w-]+/g, '')
                    .replace(/--+/g, '-')
                    .replace(/^-+/, '')
                    .replace(/-+$/, '');
            };

            const slug = generateSlug(brandName);
            const fileName = `logo_${brandId}_${Date.now()}.${file.name.split('.').pop()}`;
            const filePath = `logos/${fileName}`;

            try {
                showToast("Uploading logo...", "info");
                
                // 1. Upload to storage
                const { error: uploadErr } = await _supabase.storage
                    .from(STORAGE_BUCKET)
                    .upload(filePath, file);

                if (uploadErr) throw uploadErr;

                // 2. Get Public URL
                const { data: { publicUrl } } = _supabase.storage
                    .from(STORAGE_BUCKET)
                    .getPublicUrl(filePath);

                // 3. Update 'brands' table
                // Including 'name' and 'slug' to avoid NOT NULL constraint violations
                const { error: dbErr } = await _supabase
                    .from('brands')
                    .upsert({ 
                        id: brandId, 
                        name: brandName, 
                        slug: slug,
                        logo_url: publicUrl 
                    }, { onConflict: 'id' });

                if (dbErr) throw dbErr;

                showToast("Logo updated successfully!", "success");
                loadBrandMetadata();
            } catch (err) {
                console.error("Logo upload failed:", err);
                showToast("Logo upload failed: " + err.message, "error");
            }
        };

        async function loadWeeklyData() {
            const { monday, sunday } = getWeekInfo(viewDate);
            const monF = monday.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
            const sunF = sunday.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
            weekRangeDisplay.innerText = `${monF} to ${sunF}`;

            const startStr = monday.toISOString().split('T')[0];
            const endStr = sunday.toISOString().split('T')[0];
            const brandId = brandSelect.value;

            try {
                const { data: slots } = await _supabase
                    .from('post_slots')
                    .select('scheduled_date')
                    .eq('brand_id', brandId)
                    .gte('scheduled_date', startStr)
                    .lte('scheduled_date', endStr);

                const activeDates = new Set(slots?.map(s => s.scheduled_date) || []);
                
                const { data: approval } = await _supabase
                    .from('weekly_approvals')
                    .select('*')
                    .eq('brand_id', brandId)
                    .eq('week_start_date', startStr)
                    .maybeSingle();

                isWeekApproved = approval?.status === 'approved';
                updateApprovalUI(approval?.status || 'drafting');

                weekDaysGrid.innerHTML = '';
                const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                for (let i = 0; i < 7; i++) {
                    const currentDay = new Date(monday);
                    currentDay.setDate(monday.getDate() + i);
                    const iso = currentDay.toISOString().split('T')[0];
                    const hasPost = activeDates.has(iso);
                    const isSelected = iso === postDateInput.value;

                    weekDaysGrid.innerHTML += `
                        <div onclick="selectDate('${iso}')" class="flex flex-col items-center gap-2 cursor-pointer group">
                            <span class="text-[9px] font-bold ${isSelected ? 'text-emerald-600' : 'text-slate-400'} uppercase">${dayNames[i]}</span>
                            <div class="w-8 h-8 rounded-full transition-all flex items-center justify-center text-[10px] font-bold 
                                ${hasPost ? 'day-active shadow-md' : 'bg-slate-50 text-slate-300'} 
                                ${isSelected ? 'ring-2 ring-emerald-500 ring-offset-2' : 'group-hover:bg-slate-100'}">
                                ${currentDay.getDate()}
                            </div>
                        </div>
                    `;
                }
            } catch (err) { console.error(err); }
        }

        // 2. Fetch Existing Post for Selected Date
        async function fetchPostForDate(iso) {
            const brandId = brandSelect.value;
            historyContainer.innerHTML = '<p class="text-[10px] text-slate-400 italic">Searching records...</p>';
            
            try {
                const { data: slot } = await _supabase
                    .from('post_slots')
                    .select('*')
                    .eq('brand_id', brandId)
                    .eq('scheduled_date', iso)
                    .maybeSingle();

                if (slot) {
                    currentSlot = slot;
                    formTitle.innerText = "Edit Scheduled Post";
                    
                    const { data: versions } = await _supabase
                        .from('post_versions')
                        .select('*')
                        .eq('slot_id', slot.id)
                        .order('version_number', { ascending: false });

                    currentVersions = versions || [];
                    renderHistory(currentVersions);

                    if (currentVersions.length > 0) {
                        const latest = currentVersions[0];
                        captionInput.value = latest.caption || "";
                        versionLabel.innerText = `Drafting: Version ${latest.version_number + 1}`;
                        
                        const { data: assets } = await _supabase
                            .from('media_assets')
                            .select('file_url')
                            .eq('version_id', latest.id)
                            .order('order_index');

                        renderExistingMedia(assets || []);
                        updatePreview();
                    } else {
                        renderExistingMedia([]);
                        updatePreview();
                    }
                } else {
                    resetFormToNew();
                }
            } catch (err) { console.error(err); }
        }

        function renderExistingMedia(assets) {
            if (!assets || assets.length === 0) {
                existingMediaDisplay.innerHTML = "";
                previewMedia.innerHTML = MEDIA_PLACEHOLDER;
                return;
            }

            existingMediaDisplay.innerHTML = assets.map(a => `
                <div class="relative w-16 h-16 rounded-lg overflow-hidden border border-slate-200">
                    <img src="${a.file_url}" class="w-full h-full object-cover">
                </div>
            `).join('');
            
            previewMedia.innerHTML = `<img src="${assets[0].file_url}" class="w-full h-full object-cover">`;
        }

        function renderHistory(versions) {
            if (versions.length === 0) {
                historyContainer.innerHTML = '<p class="text-[10px] text-slate-400 italic">No history found.</p>';
                return;
            }
            historyContainer.innerHTML = versions.map(v => `
                <div class="p-3 bg-white border border-slate-100 rounded-xl text-left shadow-sm">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-[9px] font-bold text-slate-400 uppercase">Version ${v.version_number}</span>
                        <span class="text-[8px] font-bold px-2 py-0.5 rounded-full bg-slate-50 text-slate-500 uppercase">${v.status || 'draft'}</span>
                    </div>
                    <p class="text-[10px] text-slate-600 line-clamp-2">${v.caption || 'No caption text'}</p>
                </div>
            `).join('');
        }

        window.resetFormToNew = () => {
            currentSlot = null;
            currentVersions = [];
            formTitle.innerText = "Content Composer";
            versionLabel.innerText = "New Post";
            captionInput.value = "";
            existingMediaDisplay.innerHTML = "";
            previewMedia.innerHTML = MEDIA_PLACEHOLDER;
            mediaContainer.innerHTML = `
                <div class="flex items-center gap-3 p-3 border border-dashed border-slate-300 rounded-xl bg-slate-50/50">
                    <div class="file-input-wrapper">
                        <button class="w-full text-left text-xs text-slate-500 font-medium py-1 px-2 text-ellipsis overflow-hidden">Click to select file...</button>
                        <input type="file" class="media-file-input" accept="image/*,video/*" onchange="handleFileSelect(this)">
                    </div>
                    <span class="file-name text-[10px] text-slate-400 italic truncate max-w-[150px]">No file chosen</span>
                </div>
            `;
            historyContainer.innerHTML = '<p class="text-[10px] text-slate-400 italic">New draft started.</p>';
            updatePreview();
        };

        // 3. Submit Logic
        window.submitPost = async () => {
            const btn = submitBtn;
            const msg = msgBox;
            
            // 1. Validation
            const date = postDateInput.value;
            const caption = captionInput.value;
            const fileInputs = Array.from(document.querySelectorAll('.media-file-input'));
            const files = fileInputs.map(input => input.files[0]).filter(Boolean);

            // Important: Check if anything is actually being uploaded or changed
            if (files.length === 0 && !caption) {
                showToast("Please provide a caption or select a file to upload.", "error");
                return;
            }

            btn.disabled = true;
            btn.innerText = "Uploading Media...";
            
            try {
                // 1. Upload files to Storage
                const uploadedUrls = [];
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const fileName = `${Date.now()}_${i}.${file.name.split('.').pop()}`;
                    const filePath = `${brandSelect.value}/${fileName}`;
                    
                    btn.innerText = `Uploading Part ${i+1}...`;
                    
                    const { error: uploadErr } = await _supabase.storage
                        .from(STORAGE_BUCKET)
                        .upload(filePath, file);
                    
                    if (uploadErr) throw uploadErr;
                    
                    const { data: { publicUrl } } = _supabase.storage
                        .from(STORAGE_BUCKET)
                        .getPublicUrl(filePath);
                        
                    uploadedUrls.push(publicUrl);
                }

                btn.innerText = "Finalizing Records...";

                // 2. Handle/Find Slot
                let slotId = currentSlot?.id;
                if (!slotId) {
                    // Double check if slot exists for this date before inserting (prevent race conditions)
                    const { data: existingSlot } = await _supabase
                        .from('post_slots')
                        .select('id')
                        .eq('brand_id', brandSelect.value)
                        .eq('scheduled_date', date)
                        .maybeSingle();

                    if (existingSlot) {
                        slotId = existingSlot.id;
                    } else {
                        const { data: newSlot, error: sErr } = await _supabase
                            .from('post_slots')
                            .insert([{ brand_id: brandSelect.value, scheduled_date: date }])
                            .select()
                            .single();
                        if (sErr) throw sErr;
                        slotId = newSlot.id;
                    }
                }

                // 3. Create New Version
                const nextVerNum = (currentVersions[0]?.version_number || 0) + 1;
                const { data: version, error: vErr } = await _supabase
                    .from('post_versions')
                    .insert([{ slot_id: slotId, version_number: nextVerNum, caption: caption, status: 'pending' }])
                    .select()
                    .single();
                
                if (vErr) throw vErr;

                // 4. Media Assets
                if (uploadedUrls.length > 0) {
                    const assets = uploadedUrls.map((url, idx) => ({ 
                        version_id: version.id, 
                        file_url: url, 
                        order_index: idx 
                    }));
                    const { error: assetErr } = await _supabase.from('media_assets').insert(assets);
                    if (assetErr) throw assetErr;
                }

                showToast(`Successfully saved Version ${nextVerNum}`, "success");
                loadWeeklyData();
                fetchPostForDate(date);
            } catch (err) {
                console.error("Submission error:", err);
                showToast("Error: " + err.message, "error");
            } finally {
                btn.disabled = false;
                btn.innerText = "Submit Version";
            }
        };

        // UI Standard helpers
        window.updateApprovalUI = (status) => {
            if (status === 'approved') {
                weeklyStatusBadge.innerText = "Approved for Rollout";
                weeklyStatusBadge.className = "bg-emerald-50 text-emerald-700 text-[10px] font-bold px-3 py-1 rounded-full uppercase tracking-widest";
            } else if (status === 'pending_review') {
                weeklyStatusBadge.innerText = "Review Requested";
                weeklyStatusBadge.className = "bg-indigo-50 text-indigo-700 text-[10px] font-bold px-3 py-1 rounded-full uppercase tracking-widest";
            } else {
                weeklyStatusBadge.innerText = "Work in Progress";
                weeklyStatusBadge.className = "bg-amber-50 text-amber-700 text-[10px] font-bold px-3 py-1 rounded-full uppercase tracking-widest";
            }
        };

        window.toggleWeeklyApproval = async () => {
            const { monday } = getWeekInfo(viewDate);
            const startStr = monday.toISOString().split('T')[0];
            const nextStatus = isWeekApproved ? 'drafting' : 'pending_review';
            await _supabase.from('weekly_approvals').upsert({ brand_id: brandSelect.value, week_start_date: startStr, status: nextStatus }, { onConflict: 'brand_id,week_start_date' });
            loadWeeklyData();
        };

        window.handleFileSelect = (input) => {
            const fileNameSpan = input.parentElement.parentElement.querySelector('.file-name');
            if (input.files[0]) {
                fileNameSpan.innerText = input.files[0].name;
                if (input === document.querySelector('.media-file-input')) {
                    const reader = new FileReader();
                    reader.onload = (e) => { 
                        previewMedia.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover">`; 
                    };
                    reader.readAsDataURL(input.files[0]);
                }
            }
        };

        function showToast(m, type) {
            msgBox.classList.remove('hidden', 'bg-emerald-50', 'bg-rose-50', 'bg-indigo-50');
            const color = type === 'success' ? 'bg-emerald-50 text-emerald-700' : type === 'error' ? 'bg-rose-50 text-rose-700' : 'bg-indigo-50 text-indigo-700';
            msgBox.className = `mb-4 text-xs font-medium min-h-[1.5rem] p-3 rounded-lg ${color}`;
            msgBox.innerText = m;
            setTimeout(() => msgBox.classList.add('hidden'), 5000);
        }

        window.setPostType = (type) => {
            postType = type;
            document.querySelectorAll('.type-btn').forEach(b => b.classList.replace('bg-slate-900', 'border-slate-200'));
            document.getElementById(`btn-${type}`).classList.replace('border-slate-200', 'bg-slate-900');
        };

        window.addSlide = () => {
            const div = document.createElement('div');
            div.className = "flex items-center gap-3 p-3 border border-dashed border-slate-300 rounded-xl bg-slate-50/50";
            div.innerHTML = `<div class="file-input-wrapper flex-1"><button class="w-full text-left text-xs text-slate-500 font-medium py-1 px-2">Next file...</button><input type="file" class="media-file-input" accept="image/*,video/*" onchange="handleFileSelect(this)"></div><span class="file-name text-[10px] text-slate-400 italic truncate max-w-[150px]">No file</span><button onclick="this.parentElement.remove()" class="text-slate-300 hover:text-rose-500"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>`;
            mediaContainer.appendChild(div);
        };

        window.updatePreview = () => {
            previewCaption.innerText = captionInput.value || "Captions help tell your story...";
        };

        captionInput.oninput = updatePreview;
        
        // Initial load sequence
        loadBrandMetadata();
        loadWeeklyData();
    </script>
</body>
</html>
