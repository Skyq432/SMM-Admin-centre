<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Command Center | Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #f8fafc;
        }
        .glass-card {
            background: rgba(255, 255, 255, 1);
            border: 1px solid #e2e8f0;
        }
        .mobile-mockup {
            width: 280px;
            height: 480px;
            border: 10px solid #0f172a;
            border-radius: 36px;
            position: relative;
            overflow: hidden;
            background: white;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 10px;
        }
        .btn-emerald {
            background-color: #059669;
            transition: all 0.2s ease;
        }
        .btn-emerald:hover {
            background-color: #047857;
        }
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }
        .file-input-wrapper input[type=file] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
        }
        
        /* Status Indicators in Grid */
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            border: 1.5px solid white;
            z-index: 10;
        }
        .dot-approved { background-color: #10b981; box-shadow: 0 0 8px rgba(16, 185, 129, 0.6); }
        .dot-pending { background-color: #f59e0b; box-shadow: 0 0 8px rgba(245, 158, 11, 0.6); }
        .dot-rejected { background-color: #ef4444; box-shadow: 0 0 8px rgba(239, 68, 68, 0.6); }

        .day-circle {
            position: relative;
            transition: all 0.2s ease;
        }
        .day-active {
            background-color: #ffffff;
            color: #0f172a;
            border: 1px solid #e2e8f0;
        }
        .day-selected {
            ring: 2px solid #059669;
            ring-offset: 2px;
            background-color: #ecfdf5 !important;
            border-color: #059669 !important;
        }

        /* Carousel Styles for Mockup */
        .carousel-track {
            display: flex;
            transition: transform 0.3s ease-in-out;
        }
        .carousel-item {
            min-width: 100%;
            height: 280px;
        }
        .carousel-dots {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 4px;
        }
        .dot {
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background: rgba(255,255,255,0.5);
        }
        .dot.active {
            background: white;
            width: 7px;
        }
    </style>
</head>
<body class="text-slate-800 antialiased">

    <header class="sticky top-0 z-50 w-full border-b border-slate-200 bg-white/90 backdrop-blur-md px-6 py-3">
        <div class="max-w-7xl mx-auto flex flex-wrap items-center justify-between gap-4">
            <div class="flex items-center gap-8">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-slate-900 rounded-lg flex items-center justify-center text-white font-bold text-xs">CC</div>
                    <h1 class="text-lg font-bold text-slate-900 tracking-tight uppercase">Admin Center</h1>
                </div>
                
                <div class="flex items-center gap-6">
                    <div class="flex items-center gap-3">
                        <div class="relative group cursor-pointer" onclick="document.getElementById('logoUploadInput').click()">
                            <img id="brandLogoDisplay" src="https://ui-avatars.com/api/?name=B&background=f1f5f9&color=cbd5e1" alt="Logo" class="w-9 h-9 rounded-lg border border-slate-200 object-contain bg-white">
                            <input type="file" id="logoUploadInput" class="hidden" accept="image/*" onchange="uploadBrandLogo(this)">
                        </div>
                        <div class="flex flex-col">
                            <label class="text-[9px] font-bold uppercase text-slate-400 tracking-widest">Brand Profile</label>
                            <select id="brandSelect" class="bg-transparent font-bold focus:outline-none text-slate-800 text-sm cursor-pointer" onchange="handleBrandChange()">
                                <option value="19d27e5f-b230-4c2a-a5a7-6c2e59fbba88">Natures Treasure</option>
                                <option value="8a3d5f21-e7c4-4b5a-9311-6c2e59fbba99">Idonstore</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="h-6 w-px bg-slate-200"></div>
                    
                    <div class="flex flex-col">
                        <label class="text-[9px] font-bold uppercase text-slate-400 tracking-widest">Post Schedule</label>
                        <input type="date" id="postDate" class="bg-transparent font-bold focus:outline-none text-slate-800 text-sm cursor-pointer" onchange="syncWeekWithDate()">
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-3">
                <button onclick="generateApprovalLink()" class="text-[10px] font-bold text-slate-500 border border-slate-200 px-3 py-1.5 rounded-lg hover:bg-slate-50 uppercase tracking-widest flex items-center gap-2">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg>
                    Copy Client Link
                </button>
                <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 font-bold border border-slate-200">AD</div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-6 grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <div class="lg:col-span-7 space-y-6">
            <!-- WEEKLY NAVIGATION -->
            <div class="glass-card rounded-2xl p-6 shadow-sm mb-6 border-l-4 border-l-emerald-500">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-4">
                        <button onclick="changeWeek(-1)" class="p-2 hover:bg-slate-50 rounded-full text-slate-400">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                        </button>
                        <h3 id="weekRangeDisplay" class="text-sm font-bold text-slate-900 uppercase tracking-widest">Loading week...</h3>
                        <button onclick="changeWeek(1)" class="p-2 hover:bg-slate-50 rounded-full text-slate-400">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </button>
                    </div>
                    <div id="weeklyStatusBadge" class="bg-amber-50 text-amber-700 text-[10px] font-bold px-3 py-1 rounded-full uppercase tracking-widest">Drafting</div>
                </div>

                <div id="weekDaysGrid" class="grid grid-cols-7 gap-2 mb-10"></div>

                <div class="flex items-center justify-between pt-4 border-t border-slate-100">
                    <div class="flex items-center gap-4">
                        <button onclick="resetFormToNew()" class="text-[9px] font-bold text-indigo-500 uppercase hover:underline text-left">Clear / Create New</button>
                        <button id="deletePostBtn" onclick="initiateDelete()" class="hidden text-[9px] font-bold text-rose-500 uppercase hover:underline text-left">Delete Entire Post</button>
                    </div>
                    <button id="approveWeekBtn" onclick="toggleWeeklyApproval()" class="bg-slate-900 text-white text-[10px] font-bold px-4 py-2 rounded-lg hover:bg-slate-800 transition-all uppercase tracking-widest">
                        Submit Week
                    </button>
                </div>
            </div>

            <!-- COMPOSER -->
            <div class="glass-card rounded-2xl p-8 shadow-sm">
                <div class="flex items-center justify-between mb-8">
                    <div>
                        <h2 class="text-xl font-bold text-slate-900" id="formTitle">Composer</h2>
                        <p class="text-slate-500 text-xs" id="typeIndicator">Create a Single Post</p>
                    </div>
                    <div id="versionLabel" class="bg-slate-100 text-slate-600 text-[10px] font-bold px-3 py-1 rounded-full uppercase">New Post</div>
                </div>

                <div class="mb-6">
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-3">Content Type</label>
                    <div class="flex gap-2">
                        <button onclick="setPostType('single')" id="btn-single" class="type-btn flex-1 py-2 text-xs font-bold rounded-lg bg-slate-900 text-white transition-all">Single</button>
                        <button onclick="setPostType('carousel')" id="btn-carousel" class="type-btn flex-1 py-2 text-xs font-bold rounded-lg border border-slate-200 text-slate-500 hover:bg-slate-50">Carousel</button>
                        <button onclick="setPostType('video')" id="btn-video" class="type-btn flex-1 py-2 text-xs font-bold rounded-lg border border-slate-200 text-slate-500 hover:bg-slate-50">Video</button>
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">Caption</label>
                    <textarea id="captionInput" rows="4" class="w-full p-4 rounded-xl border border-slate-200 focus:ring-1 focus:ring-emerald-500 outline-none text-sm leading-relaxed" placeholder="Write your post caption..."></textarea>
                </div>

                <div class="mb-10">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest">Media Assets</label>
                            <p class="text-[9px] text-slate-400 font-medium italic">Upload, or use Ctrl+V to paste an image.</p>
                        </div>
                        <button onclick="addSlide()" id="addSlideBtn" class="text-[10px] font-bold text-emerald-600 hover:text-emerald-700 uppercase tracking-widest">+ Add Slide</button>
                    </div>
                    <div id="mediaContainer" class="space-y-3"></div>
                    <div id="existingMediaDisplay" class="mt-4 flex flex-wrap gap-2"></div>
                </div>

                <button id="submitBtn" onclick="submitPost()" class="w-full btn-emerald text-white font-bold py-4 rounded-xl shadow-lg transition-all flex items-center justify-center gap-2">
                    Submit Version
                </button>
            </div>
        </div>

        <div class="lg:col-span-5 space-y-8">
            <!-- LIVE PREVIEW -->
            <div class="glass-card rounded-2xl p-8 flex flex-col items-center shadow-sm">
                <h3 class="text-[10px] font-bold text-slate-400 mb-6 uppercase tracking-widest">Mobile Preview</h3>
                <div class="mobile-mockup">
                    <div class="px-4 py-3 flex items-center gap-2 border-b border-slate-50 bg-white">
                        <div id="previewLogo" class="w-5 h-5 rounded bg-slate-100 overflow-hidden">
                            <img id="previewLogoImg" src="" class="w-full h-full object-contain hidden">
                        </div>
                        <span id="previewBrand" class="text-[10px] font-bold text-slate-800">Brand</span>
                    </div>
                    <div id="previewMedia" class="w-full h-[280px] bg-slate-50 flex items-center justify-center relative overflow-hidden text-center p-4">
                        <span class="text-[10px] text-slate-300 font-medium italic">No Asset Provided</span>
                    </div>
                    <div class="p-4">
                        <div class="flex items-center gap-3 mb-3 text-slate-700">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                        </div>
                        <p id="previewCaption" class="text-[11px] text-slate-600 leading-normal line-clamp-4">Captions help tell your story...</p>
                    </div>
                </div>
            </div>

            <!-- VERSION HISTORY -->
            <div class="glass-card rounded-2xl p-6 shadow-sm flex flex-col max-h-[600px]">
                <h3 class="text-xs font-bold text-slate-900 mb-4 flex items-center gap-2 uppercase tracking-widest">History & Feedback</h3>
                <div id="historyContainer" class="space-y-4 overflow-y-auto custom-scrollbar flex-1 pr-2 text-center py-8">
                    <p class="text-[10px] text-slate-400 italic">Select a date.</p>
                </div>
            </div>
        </div>
    </main>

    <!-- CUSTOM DELETE MODAL -->
    <div id="deleteModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[200] hidden items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-sm w-full p-8 shadow-2xl transform transition-all scale-95 opacity-0 duration-300" id="deleteModalContent">
            <div class="w-12 h-12 bg-rose-50 text-rose-500 rounded-full flex items-center justify-center mb-4">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
            </div>
            <h4 class="text-lg font-bold text-slate-900 mb-2 tracking-tight">Delete Whole Post?</h4>
            <p class="text-sm text-slate-500 mb-8 leading-relaxed">This will remove all versions, media assets, and history for this day. This action cannot be undone.</p>
            <div class="flex gap-3">
                <button onclick="closeDeleteModal()" class="flex-1 py-3 text-sm font-bold text-slate-500 border border-slate-200 rounded-xl hover:bg-slate-50 transition-colors">Cancel</button>
                <button onclick="executeDelete()" id="confirmDeleteBtn" class="flex-1 py-3 text-sm font-bold text-white bg-rose-500 rounded-xl hover:bg-rose-600 shadow-lg shadow-rose-100 transition-all">Confirm Delete</button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-6 right-6 px-6 py-3 rounded-xl shadow-2xl text-white font-bold text-sm transform translate-y-24 transition-all duration-300 z-[100] opacity-0 pointer-events-none"></div>

    <script>
        const supabaseUrl = 'https://ohflkfevuapwqtkpsqlo.supabase.co';
        const supabaseKey = 'sb_publishable_U2yJZn0K-XQF_0bGPfGvJQ_hA5-ja0F';
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);
        const STORAGE_BUCKET = 'media';

        let postType = 'single';
        let viewDate = new Date();
        let isWeekApproved = false;
        let currentSlot = null;
        let currentVersions = [];
        let pastedFiles = [];
        let previewAssets = [];
        let carouselInterval = null;
        let carouselIndex = 0;

        const captionInput = document.getElementById('captionInput');
        const mediaContainer = document.getElementById('mediaContainer');
        const existingMediaDisplay = document.getElementById('existingMediaDisplay');
        const previewMedia = document.getElementById('previewMedia');
        const previewCaption = document.getElementById('previewCaption');
        const msgBox = document.getElementById('msg');
        const submitBtn = document.getElementById('submitBtn');
        const postDateInput = document.getElementById('postDate');
        const weekRangeDisplay = document.getElementById('weekRangeDisplay');
        const weekDaysGrid = document.getElementById('weekDaysGrid');
        const weeklyStatusBadge = document.getElementById('weeklyStatusBadge');
        const approveWeekBtn = document.getElementById('approveWeekBtn');
        const deletePostBtn = document.getElementById('deletePostBtn');
        const brandSelect = document.getElementById('brandSelect');
        const versionLabel = document.getElementById('versionLabel');
        const formTitle = document.getElementById('formTitle');
        const historyContainer = document.getElementById('historyContainer');
        const brandLogoDisplay = document.getElementById('brandLogoDisplay');
        const previewLogoImg = document.getElementById('previewLogoImg');
        const toast = document.getElementById('toast');
        const deleteModal = document.getElementById('deleteModal');
        const deleteModalContent = document.getElementById('deleteModalContent');

        postDateInput.valueAsDate = new Date();
        const MEDIA_PLACEHOLDER = `<span class="text-[10px] text-slate-300 font-medium italic text-center p-4">No Asset Provided</span>`;

        function getWeekInfo(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            const monday = new Date(d.setDate(diff));
            const sunday = new Date(new Date(monday).setDate(monday.getDate() + 6));
            return { monday, sunday };
        }

        window.changeWeek = (offset) => {
            viewDate.setDate(viewDate.getDate() + (offset * 7));
            loadWeeklyData();
        };

        window.syncWeekWithDate = () => {
            viewDate = new Date(postDateInput.value);
            loadWeeklyData();
            fetchPostForDate(postDateInput.value);
        };

        window.selectDate = (iso) => {
            postDateInput.value = iso;
            loadWeeklyData();
            fetchPostForDate(iso);
        };

        window.handleBrandChange = () => {
            loadBrandMetadata();
            loadWeeklyData();
            fetchPostForDate(postDateInput.value);
        };

        async function loadBrandMetadata() {
            const brandId = brandSelect.value;
            try {
                const { data } = await _supabase.from('brands').select('logo_url, name').eq('id', brandId).maybeSingle();
                document.getElementById('previewBrand').innerText = data?.name || brandSelect.options[brandSelect.selectedIndex].text;
                if (data && data.logo_url) {
                    brandLogoDisplay.src = data.logo_url;
                    previewLogoImg.src = data.logo_url;
                    previewLogoImg.classList.remove('hidden');
                } else {
                    const fallback = `https://ui-avatars.com/api/?name=${brandSelect.options[brandSelect.selectedIndex].text.charAt(0)}&background=f1f5f9&color=cbd5e1`;
                    brandLogoDisplay.src = fallback;
                    previewLogoImg.classList.add('hidden');
                }
            } catch (err) { console.error("Logo fetch error:", err); }
        }

        window.updateApprovalUI = (status) => {
            const s = status?.toLowerCase();
            if (s === 'approved') {
                weeklyStatusBadge.innerText = "Approved for Rollout";
                weeklyStatusBadge.className = "bg-emerald-50 text-emerald-700 text-[10px] font-bold px-3 py-1 rounded-full uppercase tracking-widest";
            } else if (s === 'pending_review' || s === 'pending') {
                weeklyStatusBadge.innerText = "Review Requested";
                weeklyStatusBadge.className = "bg-indigo-50 text-indigo-700 text-[10px] font-bold px-3 py-1 rounded-full uppercase tracking-widest";
            } else {
                weeklyStatusBadge.innerText = "Work in Progress";
                weeklyStatusBadge.className = "bg-amber-50 text-amber-700 text-[10px] font-bold px-3 py-1 rounded-full uppercase tracking-widest";
            }
        };

        async function loadWeeklyData() {
            const { monday, sunday } = getWeekInfo(viewDate);
            const startStr = monday.toISOString().split('T')[0];
            const endStr = sunday.toISOString().split('T')[0];
            const brandId = brandSelect.value;
            weekRangeDisplay.innerText = `${monday.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' })} to ${sunday.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' })}`;

            try {
                const { data: slots, error: slotsError } = await _supabase.from('post_slots')
                    .select('id, scheduled_date, current_status')
                    .eq('brand_id', brandId)
                    .gte('scheduled_date', startStr)
                    .lte('scheduled_date', endStr);
                
                if (slotsError) throw slotsError;

                const { data: approval } = await _supabase.from('weekly_approvals').select('*').eq('brand_id', brandId).eq('week_start_date', startStr).maybeSingle();
                isWeekApproved = approval?.status === 'approved';
                updateApprovalUI(approval?.status || 'drafting');

                weekDaysGrid.innerHTML = '';
                const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                for (let i = 0; i < 7; i++) {
                    const currentDay = new Date(monday);
                    currentDay.setDate(monday.getDate() + i);
                    const iso = currentDay.toISOString().split('T')[0];
                    const slot = slots?.find(s => s.scheduled_date === iso);
                    const status = slot?.current_status?.toLowerCase();
                    const isSelected = iso === postDateInput.value;

                    let dot = '';
                    if (status === 'approved') dot = 'dot-approved';
                    else if (status === 'rejected') dot = 'dot-rejected';
                    else if (slot) dot = 'dot-pending';

                    weekDaysGrid.innerHTML += `
                        <div onclick="selectDate('${iso}')" class="flex flex-col items-center gap-2 cursor-pointer group relative">
                            <span class="text-[9px] font-bold ${isSelected ? 'text-emerald-600' : 'text-slate-400'} uppercase">${dayNames[i]}</span>
                            <div class="w-8 h-8 rounded-full day-circle transition-all flex items-center justify-center text-[10px] font-bold 
                                ${slot ? 'day-active shadow-sm' : 'bg-slate-50 text-slate-300'} 
                                ${isSelected ? 'day-selected' : 'group-hover:bg-slate-100'}">
                                ${currentDay.getDate()}
                                ${dot ? `<div class="status-dot ${dot}"></div>` : ''}
                            </div>
                        </div>`;
                }
            } catch (err) { console.error("Grid Load Error:", err); }
        }

        async function fetchPostForDate(iso) {
            historyContainer.innerHTML = '<p class="text-[10px] text-slate-400 italic">Fetching...</p>';
            try {
                const { data: slot } = await _supabase.from('post_slots').select('*').eq('brand_id', brandSelect.value).eq('scheduled_date', iso).maybeSingle();
                if (slot) {
                    currentSlot = slot;
                    deletePostBtn.classList.remove('hidden'); // SHOW DELETE BUTTON
                    formTitle.innerText = "Edit Scheduled Post";
                    const { data: versions } = await _supabase.from('post_versions').select('*, comments(*)').eq('slot_id', slot.id).order('version_number', { ascending: false });
                    currentVersions = versions || [];
                    renderHistory(currentVersions);
                    if (currentVersions.length > 0) {
                        const latest = currentVersions[0];
                        captionInput.value = latest.caption || "";
                        versionLabel.innerText = `Version ${latest.version_number} - ${slot.current_status || 'drafting'}`;
                        const { data: assets } = await _supabase.from('media_assets').select('file_url').eq('version_id', latest.id).order('order_index');
                        previewAssets = assets || [];
                        updatePreview();
                    } else { renderExistingMedia([]); updatePreview(); }
                } else { resetFormToNew(); }
            } catch (err) { console.error("Fetch Date Error:", err); }
        }

        function renderHistory(versions) {
            if (versions.length === 0) { historyContainer.innerHTML = '<p class="text-[10px] text-slate-400 italic">No history found.</p>'; return; }
            historyContainer.innerHTML = versions.map(v => {
                const isApproved = v.is_approved === true;
                const isRejected = v.is_approved === false;
                let badge = 'bg-slate-50 text-slate-500';
                let statusText = 'Draft';
                if (isApproved) { badge = 'bg-emerald-50 text-emerald-600'; statusText = 'Approved'; }
                else if (isRejected) { badge = 'bg-rose-50 text-rose-600'; statusText = 'Rejected'; }
                const versionComments = v.comments || [];

                return `
                    <div class="p-4 bg-white border border-slate-100 rounded-xl text-left shadow-sm mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-[9px] font-bold text-slate-400 uppercase">Version ${v.version_number}</span>
                            <span class="text-[8px] font-bold px-2 py-0.5 rounded-full uppercase ${badge}">${statusText}</span>
                        </div>
                        <p class="text-[11px] text-slate-600 mb-3 leading-snug">${v.caption || 'No text'}</p>
                        ${versionComments.map(c => `
                            <div class="p-2.5 rounded-lg border-l-4 ${c.author_role === 'client' ? 'bg-rose-50 border-rose-400' : 'bg-slate-50 border-slate-300'} mb-1.5">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-[8px] font-bold uppercase ${c.author_role === 'client' ? 'text-rose-600' : 'text-slate-400'}">${c.author_role} Feedback</span>
                                </div>
                                <p class="text-[10px] ${c.author_role === 'client' ? 'text-rose-700' : 'text-slate-600'} italic leading-tight">"${c.content}"</p>
                            </div>
                        `).join('')}
                    </div>`;
            }).join('');
        }

        function renderExistingMedia(assets) {
            existingMediaDisplay.innerHTML = assets.length ? assets.map(a => `<div class="relative w-16 h-16 rounded-lg overflow-hidden border border-slate-200 shadow-sm"><img src="${a.file_url}" class="w-full h-full object-cover"></div>`).join('') : "";
            previewMedia.innerHTML = assets.length ? `<img src="${assets[0].file_url}" class="w-full h-full object-cover">` : MEDIA_PLACEHOLDER;
        }

        function setPostType(type) {
            postType = type;
            document.querySelectorAll('.type-btn').forEach(b => {
                b.classList.remove('bg-slate-900', 'text-white');
                b.classList.add('border', 'border-slate-200', 'text-slate-500');
            });
            const activeBtn = document.getElementById(`btn-${type}`);
            activeBtn.classList.remove('border', 'border-slate-200', 'text-slate-500');
            activeBtn.classList.add('bg-slate-900', 'text-white');
            document.getElementById('typeIndicator').innerText = `Create a ${type.charAt(0).toUpperCase() + type.slice(1)} ${type === 'video' ? '' : 'Post'}`;
            updatePreview();
        }

        function updatePreview() {
            previewCaption.innerText = captionInput.value || "Captions help tell your story...";
            clearInterval(carouselInterval);
            const fileInputs = Array.from(document.querySelectorAll('.media-file-input'));
            const filesFromInputs = fileInputs.map(input => input.files[0]).filter(Boolean);
            const allFiles = [...filesFromInputs, ...pastedFiles];
            if (allFiles.length === 0 && previewAssets.length === 0) {
                previewMedia.innerHTML = MEDIA_PLACEHOLDER;
                return;
            }
            const assetsToRender = allFiles.length > 0 ? allFiles : previewAssets;
            renderPreviewMedia(assetsToRender);
        }

        function renderPreviewMedia(assets) {
            if (postType === 'video') {
                const first = assets[0];
                const url = first instanceof File ? URL.createObjectURL(first) : (typeof first === 'string' ? first : (first.file_url || first));
                previewMedia.innerHTML = `<video src="${url}" autoplay muted loop class="w-full h-full object-cover"></video>`;
            } else if (postType === 'carousel' && assets.length > 1) {
                carouselIndex = 0;
                const generateItem = (asset) => {
                    const url = asset instanceof File ? URL.createObjectURL(asset) : (typeof asset === 'string' ? asset : (asset.file_url || asset));
                    return `<div class="carousel-item"><img src="${url}" class="w-full h-full object-cover"></div>`;
                };
                previewMedia.innerHTML = `<div class="carousel-track" style="transform: translateX(0)">${assets.map(generateItem).join('')}</div><div class="carousel-dots">${assets.map((_, i) => `<div class="dot ${i === 0 ? 'active' : ''}"></div>`).join('')}</div>`;
                const track = previewMedia.querySelector('.carousel-track');
                const dots = previewMedia.querySelectorAll('.dot');
                carouselInterval = setInterval(() => {
                    carouselIndex = (carouselIndex + 1) % assets.length;
                    track.style.transform = `translateX(-${carouselIndex * 100}%)`;
                    dots.forEach((d, i) => d.classList.toggle('active', i === carouselIndex));
                }, 3000);
            } else {
                const first = assets[0];
                const url = first instanceof File ? URL.createObjectURL(first) : (typeof first === 'string' ? first : (first.file_url || first));
                previewMedia.innerHTML = `<img src="${url}" class="w-full h-full object-cover">`;
            }
        }

        window.submitPost = async () => {
            const allFiles = [...Array.from(document.querySelectorAll('.media-file-input')).map(i => i.files[0]).filter(Boolean), ...pastedFiles];
            if (!allFiles.length && !captionInput.value) return showNotification("Empty content!", "error");
            submitBtn.disabled = true; submitBtn.innerText = "Submitting...";
            try {
                const urls = [];
                for (let file of allFiles) {
                    const path = `${brandSelect.value}/${Date.now()}_${file.name || 'asset.png'}`;
                    await _supabase.storage.from(STORAGE_BUCKET).upload(path, file);
                    const { data: { publicUrl } } = _supabase.storage.from(STORAGE_BUCKET).getPublicUrl(path);
                    urls.push(publicUrl);
                }
                let slotId = currentSlot?.id;
                if (!slotId) {
                    const { data } = await _supabase.from('post_slots').insert([{ brand_id: brandSelect.value, scheduled_date: postDateInput.value, current_status: 'pending' }]).select().single();
                    slotId = data.id;
                }
                const nextVer = (currentVersions[0]?.version_number || 0) + 1;
                const { data: version } = await _supabase.from('post_versions').insert([{ slot_id: slotId, version_number: nextVer, caption: captionInput.value }]).select().single();
                if (urls.length) {
                    await _supabase.from('media_assets').insert(urls.map((url, idx) => ({ version_id: version.id, file_url: url, order_index: idx })));
                }
                showNotification("Version Submitted!", "success");
                loadWeeklyData(); fetchPostForDate(postDateInput.value);
            } catch (e) { showNotification(e.message, "error"); } finally { submitBtn.disabled = false; submitBtn.innerText = "Submit Version"; }
        };

        // DELETE LOGIC
        window.initiateDelete = () => {
            if (!currentSlot) return;
            deleteModal.classList.replace('hidden', 'flex');
            setTimeout(() => {
                deleteModalContent.classList.replace('scale-95', 'scale-100');
                deleteModalContent.classList.replace('opacity-0', 'opacity-100');
            }, 10);
        };

        window.closeDeleteModal = () => {
            deleteModalContent.classList.replace('scale-100', 'scale-95');
            deleteModalContent.classList.replace('opacity-100', 'opacity-0');
            setTimeout(() => deleteModal.classList.replace('flex', 'hidden'), 300);
        };

        window.executeDelete = async () => {
            if (!currentSlot) return;
            const btn = document.getElementById('confirmDeleteBtn');
            btn.disabled = true; btn.innerText = "Deleting...";

            try {
                // Deleting the slot should cascade to versions and media if foreign keys are set up with ON DELETE CASCADE
                // If not, Supabase will throw a constraint error. 
                const { error } = await _supabase.from('post_slots').delete().eq('id', currentSlot.id);
                if (error) throw error;

                showNotification("Post removed completely.", "success");
                closeDeleteModal();
                resetFormToNew();
                loadWeeklyData();
            } catch (err) {
                showNotification("Deletion failed: " + err.message, "error");
            } finally {
                btn.disabled = false; btn.innerText = "Confirm Delete";
            }
        };

        window.generateApprovalLink = () => {
            const { monday } = getWeekInfo(viewDate);
            const link = `${window.location.origin}/client-portal?brand=${brandSelect.value}&week=${monday.toISOString().split('T')[0]}`;
            const el = document.createElement('textarea'); el.value = link; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el);
            showNotification("Link copied!", "success");
        };

        window.toggleWeeklyApproval = async () => {
            const { monday } = getWeekInfo(viewDate);
            const startStr = monday.toISOString().split('T')[0];
            const nextStatus = isWeekApproved ? 'drafting' : 'pending_review';
            await _supabase.from('weekly_approvals').upsert({ brand_id: brandSelect.value, week_start_date: startStr, status: nextStatus }, { onConflict: 'brand_id,week_start_date' });
            loadWeeklyData();
        };

        window.resetFormToNew = () => {
            currentSlot = null; currentVersions = []; pastedFiles = []; previewAssets = [];
            formTitle.innerText = "Composer"; captionInput.value = "";
            mediaContainer.innerHTML = ''; addSlide(); updatePreview();
            deletePostBtn.classList.add('hidden'); // Hide delete button on reset
        };

        window.addSlide = () => {
            const div = document.createElement('div');
            div.className = "flex items-center gap-3 p-3 border border-dashed border-slate-300 rounded-xl bg-slate-50/50";
            div.innerHTML = `<div class="file-input-wrapper flex-1"><button class="w-full text-left text-xs text-slate-500 font-medium py-1 px-2">Select file...</button><input type="file" class="media-file-input" onchange="handleFileSelect(this)"></div><button onclick="this.parentElement.remove()" class="text-rose-400 text-xs">Remove</button>`;
            mediaContainer.appendChild(div);
        };

        window.handleFileSelect = (input) => {
            const btn = input.previousElementSibling;
            if (input.files[0]) {
                btn.innerText = input.files[0].name;
                updatePreview();
            }
        };

        window.addEventListener('paste', (e) => {
            const items = e.clipboardData.items;
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf('image') !== -1) {
                    const blob = items[i].getAsFile();
                    const file = new File([blob], `paste_${Date.now()}.png`, { type: 'image/png' });
                    pastedFiles.push(file);
                    const div = document.createElement('div');
                    div.className = "p-3 border border-emerald-200 bg-emerald-50 rounded-xl flex items-center justify-between";
                    div.innerHTML = `<span class="text-[10px] text-emerald-700 font-bold uppercase">Image Pasted</span><button onclick="this.parentElement.remove(); updatePreview();" class="text-rose-400 text-xs">Remove</button>`;
                    mediaContainer.appendChild(div);
                    updatePreview();
                }
            }
        });

        function showNotification(m, type) {
            toast.className = `fixed bottom-6 right-6 px-6 py-3 rounded-xl shadow-2xl text-white font-bold text-sm transform transition-all duration-300 z-[100] ${type === 'success' ? 'bg-emerald-600' : 'bg-rose-600'}`;
            toast.innerText = m; toast.style.opacity = '1'; toast.style.transform = 'translateY(0)';
            setTimeout(() => { toast.style.opacity = '0'; toast.style.transform = 'translateY(24px)'; }, 4000);
        }

        captionInput.oninput = updatePreview;
        mediaContainer.innerHTML = ''; addSlide();
        loadBrandMetadata(); loadWeeklyData();
    </script>
</body>
</html>
